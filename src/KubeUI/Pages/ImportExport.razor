@page "/ImportExport"

<BSRow>
    <BSCol SM="12" LG="6" XL="4">
        <BSCard>
            <BSCard CardType="CardType.Header" HeadingSize="HeadingSize.H5">
                Import
            </BSCard>
            <BSCard CardType="CardType.Body">
                <div class="input-group">
                    <div class="custom-file col-sm-6 col-md-6">
                        <input type="file" class="custom-file-input" id="inputFiles" @ref="@inputTypeFileElement" @ref:suppressField multiple accept=".json,.yaml,.yml" />
                        <label class="custom-file-label" for="inputFiles">Choose file(s)</label>
                    </div>
                    <span>&nbsp;&nbsp;&nbsp;</span>
                    <BSButton @onclick="@ReadFiles" id="readFiles" >Read file(s)</BSButton>
                </div>
            </BSCard>
        </BSCard>
    </BSCol>
    <BSCol SM="12" LG="6" XL="4">
        <BSCard>
            <BSCard CardType="CardType.Header" HeadingSize="HeadingSize.H5">
                Export
            </BSCard>
            <BSCard CardType="CardType.Body">
                <div class="input-group">
                    <BSButton @onclick="@Export">Export</BSButton>
                    <span>&nbsp;&nbsp;&nbsp;</span>
                    <BSFormGroup IsRow="false" IsCheck="true">
                        <BSLabel For="@nameof(isJson)" Class="col-form-label" IsCheck="true" title="Select to export as Json, otherwise Yaml will be used.">
                            <input class="form-check-input" type="checkbox" id="@nameof(isJson)" @bind="@isJson" />
                            Json
                        </BSLabel>
                    </BSFormGroup>
                </div>
            </BSCard>
        </BSCard>
    </BSCol>
</BSRow>

@code {
    ElementReference inputTypeFileElement;

    [Inject] private IFileReaderService fileReaderService { get; set; }
    [Inject] private IBlazorFileSaver blazorFileSaver { get; set; }
    [Inject] private IState state { get; set; }
    [Inject] private IAppInsights appInsights { get; set; }

    bool isJson = false;

    public async void ReadFiles(UIMouseEventArgs args)
    {
        appInsights.TrackEvent("ReadFile");

        foreach (var file in await fileReaderService.CreateReference(inputTypeFileElement).EnumerateFilesAsync())
        {
            using (Stream stream = await file.OpenReadAsync())
            {
                using (StreamReader reader = new StreamReader(stream))
                {
                    state.ImportObject(await reader.ReadToEndAsync());
                }
            }
        }

        state.RaisePropertyChanged();
    }

    public async Task Export(UIMouseEventArgs args)
    {
        appInsights.TrackEvent("Export");

        using (MemoryStream ms = new MemoryStream())
        {
            using (ZipOutputStream zipSream = new ZipOutputStream(ms))
            {
                int count = 0;

                foreach (var coll in state.Data)
                {
                    foreach (var item in coll.Value)
                    {
                        var meta = coll.Key.GetProperty("Metadata").GetValue(item);

                        string name = meta.GetType().GetProperty("Name").GetValue(meta)?.ToString();

                        AddToZip(item, name);
                    }
                }

                void AddToZip(object obj, string name)
                {
                    string data;
                    var newObj = obj.GutObject();

                    if (isJson)
                    {
                        data = JsonConvert.SerializeObject(newObj, State.JsonSettings);
                    }
                    else
                    {
                        var serializer = new SerializerBuilder()
                            .WithTypeInspector(x => new JsonPropertyTypeInspector(x))
                            .Build();
                        data = serializer.Serialize(newObj);
                    }

                    if (string.IsNullOrEmpty(name))
                    {
                        name = "Item " + count;
                    }

                    var entry = new ZipEntry(name + $"-{newObj.GetType().Name.TrimVersionNumbers()}.{(isJson ? "json" : "yaml")}");

                    zipSream.PutNextEntry(entry);

                    byte[] bytes = Encoding.ASCII.GetBytes(data);

                    zipSream.Write(bytes, 0, bytes.Length);

                    count++;
                }
            }

            await blazorFileSaver.SaveAsBase64($"KubeUI-Export-{DateTime.Now.Ticks}.zip", Convert.ToBase64String(ms.ToArray()), "application/zip");
        }
    }
}